<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating Strategus Modules • Strategus</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating Strategus Modules">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Strategus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CreatingAnalysisSpecification.html">Creating Analysis Specification</a></li>
    <li><a class="dropdown-item" href="../articles/CreatingModules.html">Creating Strategus Modules</a></li>
    <li><a class="dropdown-item" href="../articles/ExecuteStrategus.html">Execute Strategus</a></li>
    <li><a class="dropdown-item" href="../articles/IntroductionToStrategus.html">Introduction to Strategus</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades">hadesLogo</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/Strategus/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Creating Strategus Modules</h1>
                        <h4 data-toc-skip class="author">Anthony G.
Sena</h4>
            
            <h4 data-toc-skip class="date">2024-10-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Strategus/blob/HEAD/vignettes/CreatingModules.Rmd" class="external-link"><code>vignettes/CreatingModules.Rmd</code></a></small>
      <div class="d-none name"><code>CreatingModules.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>This document aims to document the steps necessary to create analytic
module that is compatible with <a href="https://github.com/OHDSI/Strategus" class="external-link">Strategus</a>. Please treat
this document as a <strong>work in progress</strong> as Strategus is
still under development.</p>
</div>
<div class="section level2">
<h2 id="getting-started">Getting Started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>A Strategus analytic module is an R Project that uses <a href="https://rstudio.github.io/renv/index.html" class="external-link">renv</a>.
<strong>NOTE</strong>: Please make sure you are using renv &gt; 1.0.0
when creating a new analytic module to make sure it is compatible with
Strategus.</p>
<p>A Strategus module will contain the following files:</p>
<p>Here we will detail how each file is used by Strategus and what is
required in the contents of the file.</p>
<div class="section level3">
<h3 id="creating-yourprojectmodule-rproj-and-activating-renv">Creating YourProjectModule.Rproj and activating
<code>renv</code><a class="anchor" aria-label="anchor" href="#creating-yourprojectmodule-rproj-and-activating-renv"></a>
</h3>
<p>This is the R Project (.Rproj) file for your module and should end in
“Module”. You may create this as a standard R Project via RStudio. Once
the project is created, please use <code>renv::init()</code> to set up
the <code>renv</code> folder as shown above. This will create the
necessary <code>.RProfile</code> in the root of your project and the
<code>renv</code> subfolder with the necessary R code for
<code>renv</code>’s operations.</p>
</div>
<div class="section level3">
<h3 id="readme-md">README.md<a class="anchor" aria-label="anchor" href="#readme-md"></a>
</h3>
<p>This is a standard README markdown file that describes the
module.</p>
</div>
<div class="section level3">
<h3 id="news-md">NEWS.md<a class="anchor" aria-label="anchor" href="#news-md"></a>
</h3>
<p>This is a standard NEWS markdown file that is a change log for your
module. See <a href="https://blog.r-hub.io/2020/05/08/pkg-news/" class="external-link">this
post</a> for more information.</p>
</div>
<div class="section level3">
<h3 id="metadata-json">MetaData.json<a class="anchor" aria-label="anchor" href="#metadata-json"></a>
</h3>
<p>MetaData.json holds information that describes the module and its
dependencies:</p>
<p>To detail the contents of the JSON file:</p>
<ul>
<li>
<strong>Name</strong>: The name of the module</li>
<li>
<strong>Version</strong>: The version of the module. This should
have a corresponding git tag in the repository when the module is
released otherwise Strategus will not be able to download it.</li>
<li>
<strong>Dependencies</strong>: A list of modules that are required
to have successfully executed <strong>BEFORE</strong> this module is
executed. If there are no dependencies, leave this as an empty array
<code>[]</code>.</li>
<li>
<strong>TablePrefix</strong>: The prefix to use when creating the
results tables in the <code>resultsDataModelSpecification.csv</code>.
Please see <a href="#main.r">Main.R</a> for more information on how this
value is used.</li>
</ul>
</div>
<div class="section level3">
<h3 id="main-r">Main.R<a class="anchor" aria-label="anchor" href="#main-r"></a>
</h3>
<p>This file holds the main executable for your module. This file must
contain a function called <code>execute(jobContext)</code>.</p>
<p>As shown in the code above, your <code>execute(jobContext)</code>
should handle: validating the <code>jobContext</code> object to ensure
it has all of the information necessary for your code to function, a
section to execute the analytics and finally code to assemble the
output. Here we will describe the requirements for the way in which your
module must output its results:</p>
<ul>
<li>A single .ZIP file is created that holds all of the result files as
described below.</li>
<li>Output files are required to be in .CSV format. Use CohortGenerator
v0.5.0 or higher which contains a helper function for
<code><a href="https://ohdsi.github.io/CohortGenerator/reference/writeCsv.html" class="external-link">writeCsv()</a></code> which will ensure your output is formatted
properly. For more information, please see: <a href="https://ohdsi.github.io/CohortGenerator/reference/writeCsv.html" class="external-link uri">https://ohdsi.github.io/CohortGenerator/reference/writeCsv.html</a>.
<strong>IMPORTANT:</strong> File names <em>must</em> correspond to the
table names that are specified in the
<code>resultsModuleSpecification.csv</code>.</li>
<li>You must include a file named
<code>resultsModuleSpecification.csv</code> in your output directory.
The format of this file is as follows:</li>
</ul>
<p>The <code>resultsModuleSpecification.csv</code> has the following
columns:</p>
<ul>
<li>
<strong>table_name</strong>: The table name to use to hold the
data.</li>
<li>
<strong>column_name</strong>: The column name in the table.</li>
<li>
<strong>data_type</strong>: The data type for the column. See <a href="https://www.postgresql.org/docs/current/datatype.html" class="external-link uri">https://www.postgresql.org/docs/current/datatype.html</a>
for examples.</li>
<li>
<strong>is_required</strong>: Will this column allow for NULL
values? Yes/No</li>
<li>
<strong>primary_key</strong>: Is this column part of the table’s
primary key? Yes/No</li>
</ul>
</div>
<div class="section level3">
<h3 id="settingsfunctions-r">SettingsFunctions.R<a class="anchor" aria-label="anchor" href="#settingsfunctions-r"></a>
</h3>
<p>This file contains one or more functions required to create the
module settings for use in Strategus. We plan to later remove this
requirement when we can describe the module specification using the <a href="https://swagger.io/specification/" class="external-link">OpenAPI 3.0 Specification</a>.
For now, your module should contain a function similar to the
following:</p>
<p>As shown above, this example comes from the
<code>CohortGeneratorModule</code> and the function name reflects the
fact that the function will create the settings used to dictate the
behavior of the module. The parameters of the function will differ based
on the requirements of your module - if there are choices to be made
when running your module, you should include these as parameters to your
module specification function.</p>
<p>Internal to the function above, the formal parameters to the function
are used to construct a <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> named <code>analysis</code>
which holds the analysis settings. Next the <code>MetaData.json</code>
file is used to obtain the module name/version for inclusion in the
<code>specifications</code> list. The <code>specifications</code> list
contains the <code>remoteRepo</code> and <code>remoteUsername</code>
properties to indicate where your module is stored on GitHub. Finally,
we set the <code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> of the <code>specifications</code>
object to
<code>c("CohortGeneratorModuleSpecifications", "ModuleSpecifications")</code>.
For your module, you will want to substitute
<code>"CohortGeneratorModuleSpecifications"</code> for the name of your
module and retain the <code>"ModuleSpecifications"</code> in the
vector.</p>
<p>The following JSON fragment shows how the output of
<code>createCohortGeneratorModuleSpecifications()</code> is used in the
<code>moduleSpecifications</code> section of the overall analysis
settings JSON for Strategus:</p>
</div>
<div class="section level3">
<h3 id="renv-lock">renv.lock<a class="anchor" aria-label="anchor" href="#renv-lock"></a>
</h3>
<p>Each module will make use of <a href="https://rstudio.github.io/renv/articles/renv.html" class="external-link">renv</a> to
capture its R package dependencies. Furthermore, Strategus will make use
of the <code>renv</code> settings in your module to create a run-time
environment when executing your module to ensure all of the necessary
dependencies are available to your module.</p>
<p>It is recommended to use the HADES-wide renv.lock file which is
available at <a href="https://github.com/OHDSI/Hades/blob/main/hadesWideReleases" class="external-link uri">https://github.com/OHDSI/Hades/blob/main/hadesWideReleases</a>.
Find the most recent release based on the folder name and copy the
<code>renv.lock</code> file into the root of your module project.</p>
<p>If you need to install additional dependencies for your project, use
<code>renv::record()</code> to record it in the lock file.</p>
</div>
</div>
<div class="section level2">
<h2 id="extra-files">Extra files<a class="anchor" aria-label="anchor" href="#extra-files"></a>
</h2>
<p>It is advisable to add an <code>extras</code> folder to your project
to include other useful files for managing and testing your module.
We’ll detail those files here:</p>
<div class="section level3">
<h3 id="modulemaintenance-r">ModuleMaintenance.R<a class="anchor" aria-label="anchor" href="#modulemaintenance-r"></a>
</h3>
<p>This file is used to store utility functions for your module, such as
the code mentioned earlier for generating the <a href="#renv.lock">renv.lock</a> file. Here is an example of the contents
of ModuleMaintenance.R:</p>
</div>
<div class="section level3">
<h3 id="test-files">Test Files<a class="anchor" aria-label="anchor" href="#test-files"></a>
</h3>
<p>The following file is used to create a test jobContext for use in the
<code>execute(jobContext)</code> as described in <a href="#main.r">Main.R</a>:</p>
<p><a href="https://github.com/OHDSI/CohortGeneratorModule/blob/main/extras/test/CreateJobContext.R" class="external-link uri">https://github.com/OHDSI/CohortGeneratorModule/blob/main/extras/test/CreateJobContext.R</a></p>
<p>And the following file is used to create a test harness for running
your module:</p>
<p><a href="https://github.com/OHDSI/CohortGeneratorModule/blob/main/extras/test/TestModuleStandalone.R" class="external-link uri">https://github.com/OHDSI/CohortGeneratorModule/blob/main/extras/test/TestModuleStandalone.R</a></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anthony Sena, Martijn Schuemie, Jamie Gilbert.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
